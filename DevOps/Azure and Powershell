### DNS CONFIGURATION ###

# changing VM DNS must be done from AZ Powershell not locally 
# adding  DNS server via AZ Powershell
Get-AzNetworkInterface
$nic = Get-AzNetworkInterface -ResourceGroupName "RG1" -Name "azexch-03470"
$nic.DnsSettings.DnsServers.add("1.1.1.15")
## Azure DNS 168.63.129.16  
$nic.DnsSettings.DnsServers.add("168.63.129.16")
$nic | Set-AzNetworkInterface

# checking if change OK
$nic = Get-AzNetworkInterface -ResourceGroupName "RG1" -Name "azexch-04625 "
$nic.DnsSettings.DnsServers

# adding DNS server via local Powershell - - only for non-Azure VM
Get-DnsClientServerAddress
Set-DNSClientServerAddress "Ethernet" â€“ServerAddresses ("1.1.1.15", "168.63.129.16")

# resetting DNS addresses
Set-DNSClientServerAddress -ResetServerAddresses

### POWERSHELL REMOTE ###

# Enabling Remote Powershell
Enable-PSRemoting -Force
New-NetFirewallRule -Name "Allow WinRM HTTPS" -DisplayName "WinRM HTTPS" -Enabled True -Profile Any -Action Allow -Direction Inbound -LocalPort 5986 -Protocol TCP
$thumbprint = (New-SelfSignedCertificate -DnsName $env:COMPUTERNAME -CertStoreLocation Cert:\LocalMachine\My).Thumbprint
$command = "winrm create winrm/config/Listener?Address=*+Transport=HTTPS @{Hostname=""$env:computername""; CertificateThumbprint=""$thumbprint""}"
cmd.exe /C $command

Get-Item WSMan:\localhost\Client\TrustedHosts

# Machine 1 - non domain - 3.3.3.5
Set-Item -Path WSMan:\localhost\Client\TrustedHosts -Value 'dc01.kaka.local'
Set-Item -Path WSMan:\localhost\Client\TrustedHosts -Value '*.kaka.local'

# Machine 2 - domain joined - dc01.kaka.local
Set-Item -Path WSMan:\localhost\Client\TrustedHosts -Value 3.3.3.5

# checking 
Get-Item WSMan:\localhost\Client\TrustedHosts

# Connecting to remote machine in Azure via VPN 
Enter-PSSession -ComputerName 3.3.3.4 -Credential kkadm # local admin
## AD login
Enter-PSSession -ComputerName 3.3.3.4 -Credential "adm1@kaka.local" # AD admin

### AD / DOMAIN ###
# renaming machine
Rename-Computer -newname azExch-04
# adding computer to a AD domain
Add-Computer -DomainName kaka.local -Restart


### FIREWALL ###
## enabling ICMP
netsh advfirewall firewall add rule name="Allow ICMPv4" protocol="icmpv4:8,any" dir=in action=allow

### Exchange installation via Powershell on azDC03 (1vCPU/3.5GB RAM) ###

# checking software version
Get-WmiObject -Class Win32_Product | where-object name -like *Exchange* | select-object Name, Version

# removing unfinished Exchange installation
setup.exe /mode:uninstall /IAcceptExchangeServerLicenseTerms_DiagnosticDataON

## installing features
Install-WindowsFeature RSAT-Clustering-CmdInterface, NET-Framework-45-Features, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, RSAT-Clustering-Mgmt, RSAT-Clustering-PowerShell, Web-Mgmt-Console, WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-Console, Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation, RSAT-ADDS

.\Setup.exe /mode:Install /role:Mailbox /OrganizationName: /IAcceptExchangeServerLicenseTerms /IAcceptExchangeServerLicenseTerms_DiagnosticDataOFF